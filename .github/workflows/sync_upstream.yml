name: Sync Upstream and Patch

on:
  schedule:
    - cron: '0 20 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.openlist }}

      - name: Setup Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Backup sync_upstream.yml
        run: cp .github/workflows/sync_upstream.yml /tmp/

      - name: Sync upstream
        run: |
          if ! git remote | grep -q upstream; then
            git remote add upstream https://github.com/OpenListTeam/OpenList.git
          fi
          git fetch upstream
          # 强制用上游覆盖所有文件
          git reset --hard upstream/main

      - name: Restore sync_upstream.yml
        run: cp /tmp/sync_upstream.yml .github/workflows/

      - name: Apply cdnip patch
        run: |
          if ! grep -q '/cdnip' server/router.go; then
            sed -i 's|g.GET("/favicon.ico", handles.Favicon)|g.GET("/cdnip", func(c *gin.Context) { c.String(200, c.RemoteIP()) })\n\tg.GET("/favicon.ico", handles.Favicon)|' server/router.go
          fi

      - name: Disable unwanted workflow triggers
        run: |
          # 安装 yq
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          
          # 修改 workflow 触发器，只保留 workflow_dispatch
          for file in test_docker.yml sync_repo.yml beta_release.yml; do
            yq -i '.on = {"workflow_dispatch": null}' .github/workflows/$file
          done

      - name: Patch beta_release to build linux-amd64 only
        run: |
          # 修改 strategy matrix，只保留 linux-amd64
          yq -i '.jobs.release.strategy.matrix.include = [{"target": "linux-amd64", "hash": "md5"}]' .github/workflows/beta_release.yml

      - name: First push - disable triggers (prevents other workflows from running on second push)
        run: |
          git add .github/workflows/
          if ! git diff --staged --quiet; then
            git commit -m "chore: disable workflow triggers"
            git push --force
          fi

      - name: Commit and push remaining changes
        run: |
          git add .
          if ! git diff --staged --quiet; then
            git commit -m "chore: sync upstream and apply custom patches"
            git push --force
          else
            echo "No changes to commit"
          fi

      - name: Trigger beta release build
        run: |
          gh workflow run beta_release.yml --ref main --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
